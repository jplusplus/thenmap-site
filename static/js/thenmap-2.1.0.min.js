var Thenmap={debug:!1,apiUrl:"//thenmap-api.herokuapp.com/v2/",el:null,svg:null,css:null,defaultColor:"#e2e2e2",settings:{width:800,height:null,language:null,projection:null,data:null,dataKey:null,map:"world-2",date:(new Date).toISOString(),callback:null},init:function(e,t){var r=this;r.ColorLayer.thenmap=r,t.width=t.width?parseInt(t.width):null,t.height=t.height?parseInt(t.height):null,"dataset"in t&&(console.log("Warning, the “dataset” parameter has been renamed “map”. Using “dataset” will stop working in future versions."),t.map=t.dataset),r.settings=r.utils.extend(r.settings,t),"string"==typeof e?(e=e.replace(/^#/,""),r.el=document.getElementById(e)):e.nodeType?r.el=e:r.log(e+" is not a valid id name or DOM node."),r.settings.width&&(r.el.style.width=r.settings.width+"px"),r.settings.height&&(r.el.style.height=r.settings.height+"px");var s=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(s),this.css=s;var i=i||{};i["src/styles.css"]='svg.thenmap {\n  stroke: white;\n  stroke-width: .5px\n}\n@keyframes loading_data {\n  0% {fill-opacity: .25}\n  100% {fill-opacity: .75}\n}\n.loading_data path {\n  animation: loading_data 1s linear infinite alternate;\n}\n\n@media screen and (-webkit-min-device-pixel-ratio:0){\n\tsvg.thenmap path:hover {\n\t  filter: url("#sepia") !important; /*Chrome*/\n\t}\t\n}\nsvg.thenmap path:hover {\n  -webkit-filter: sepia(50%);\n  filter: sepia(50%);\n}',r.extendCss(i["src/styles.css"]),r.HttpClient.get(r.createApiUrl(),function(e){var t=document.createElement("div");t.innerHTML=e,r.svg=t.getElementsByTagName("svg")[0];var s=r.svg.getElementsByTagName("defs")[0],i="http://www.w3.org/2000/svg",n=document.createElementNS(i,"filter");n.id="sepia",n.innerHTML="<feColorMatrix type='matrix' values='0.35 0.35 0.35 0 0         0.25 0.25 0.25 0 0         0.15 0.15 0.15 0 0         0.50 0.50 0.50 1 0'/>",s.appendChild(n),r.el.appendChild(r.svg);for(var a=r.el.getElementsByTagName("path"),o=a.length;o--;){var l=document.createElementNS(i,"title");l.textContent=a[o].getAttribute("thenmap:name"),a[o].appendChild(l),a[o].setAttribute("class",a[o].getAttribute("thenmap:class"))}r.settings.data?r.ColorLayer.render(r.settings.data):r.settings.dataKey&&r.ColorLayer.init(r.settings.dataKey),"function"==typeof r.settings.callback&&r.settings.callback(null,this)})},createApiUrl:function(){var e=this.apiUrl;e+=[this.settings.map,"svg",this.settings.date].join("/");var t=["svg_props=name|class"],s={width:"svg_width",height:"svg_height",projection:"svg_proj",language:"language"};for(var i in s){var n=s[i];null!==this.settings[i]&&t.push(n+"="+this.settings[i])}return e+="?"+t.join("&")},extendCss:function(e){this.css.styleSheet?this.css.styleSheet.cssText+=e:this.css.innerHTML+=e},HttpClient:{get:function(e,t){var s=new XMLHttpRequest;s.onreadystatechange=function(){4==s.readyState&&200==s.status&&t(s.responseText)},s.open("GET",e,!0),s.send(null)}},ColorLayer:{getSpreadsheetData:function(e,t){Tabletop.init({key:e,callback:t,simpleSheet:!0})},getColorCode:function(e){e=e.trim();return/(^#[0-9A-F]{6}$){1,2}/i.test(e)?e:/(^[0-9A-F]{6}$){1,2}/i.test(e)?"#"+e:-1<["aliceblue","antiquewhite","aqua","aquamarine","azure","beige","bisque","black","blanchedalmond","blue","blueviolet","brown","burlywood","cadetblue","chartreuse","chocolate","coral","cornflowerblue","cornsilk","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgray","darkgreen","darkgrey","darkkhaki","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategray","darkslategrey","darkturquoise","darkviolet","deeppink","deepskyblue","dimgray","dimgrey","dodgerblue","firebrick","floralwhite","forestgreen","fuchsia","gainsboro","ghostwhite","gold","goldenrod","gray","grey","green","greenyellow","honeydew","hotpink","indianred","indigo","ivory","khaki","lavender","lavenderblush","lawngreen","lemonchiffon","lightblue","lightcoral","lightcyan","lightgoldenrodyellow","lightgray","lightgreen","lightgrey","    ","","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategray","lightslategrey","lightsteelblue","lightyellow","lime","limegreen","linen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","mintcream","mistyrose","moccasin","navajowhite","navy","oldlace","olive","olivedrab","orange","orangered","orchid","palegoldenrod","palegreen","paleturquoise","palevioletred","papayawhip","peachpuff","peru","pink","plum","powderblue","purple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","seashell","sienna","silver","skyblue","slateblue","slategray","slategrey","snow","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","wheat","white","whitesmoke","yellow","yellowgreen"].indexOf(e.toLowerCase())?e.toLowerCase():/rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/i.test(e)?e.toLowerCase():this.thenmap.defaultColor},render:function(e){for(var t={},s=e.length;s--;){var i=e[s];if(i.color){var n=this.getColorCode(i.color),a="path."+i.id;n in t?t[n].push(a):t[n]=[a]}}var o="";for(var l in t)o+=t[l].join(", ")+"{fill:"+l+"}\n";this.thenmap.extendCss(o)},init:function(e){var t=this,s=t.thenmap.el.className||"";t.thenmap.el.className=[s,"loading_data"].join(" "),t.getSpreadsheetData(e,function(e){t.thenmap.el.className=s,t.render(e)})}},utils:{extend:function(e,t){var s,i={};for(s in e)Object.prototype.hasOwnProperty.call(e,s)&&(i[s]=e[s]);for(s in t)Object.prototype.hasOwnProperty.call(t,s)&&(i[s]=t[s]);return i}},log:function(e){this.debug&&console.log(e+"\nIn function:"+arguments.callee.caller.name)}};!function(){"use strict";var l=!1;if("undefined"!=typeof process&&!process.browser){l=!0;var t=require("request".trim())}var r=!1,n=!1;try{void 0!==(new XMLHttpRequest).withCredentials?r=!0:"XDomainRequest"in window&&(n=r=!0)}catch(e){}var a=Array.prototype.indexOf,s=function(e,t){var s=0,i=e.length;if(a&&e.indexOf===a)return e.indexOf(t);for(;s<i;s++)if(e[s]===t)return s;return-1},o=function(e){if(!(this&&this instanceof o))return new o(e);"string"==typeof e&&(e={key:e}),this.callback=e.callback,this.wanted=e.wanted||[],this.key=e.key,this.simpleSheet=!!e.simpleSheet,this.parseNumbers=!!e.parseNumbers,this.wait=!!e.wait,this.reverse=!!e.reverse,this.postProcess=e.postProcess,this.debug=!!e.debug,this.query=e.query||"",this.orderby=e.orderby,this.endpoint=e.endpoint||"https://spreadsheets.google.com",this.singleton=!!e.singleton,this.simpleUrl=!(!e.simpleUrl&&!e.simple_url),this.callbackContext=e.callbackContext,this.prettyColumnNames=void 0===e.prettyColumnNames?!e.proxy:e.prettyColumnNames,void 0!==e.proxy&&(this.endpoint=e.proxy.replace(/\/$/,""),this.simpleUrl=!0,this.singleton=!0,r=!1),this.parameterize=e.parameterize||!1,this.singleton&&(void 0!==o.singleton&&this.log("WARNING! Tabletop singleton already defined"),o.singleton=this),/key=/.test(this.key)&&(this.log("You passed an old Google Docs url as the key! Attempting to parse."),this.key=this.key.match("key=(.*?)(&|#|$)")[1]),/pubhtml/.test(this.key)&&(this.log("You passed a new Google Spreadsheets url as the key! Attempting to parse."),this.key=this.key.match("d\\/(.*?)\\/pubhtml")[1]),/spreadsheets\/d/.test(this.key)&&(this.log("You passed the most recent version of Google Spreadsheets url as the key! Attempting to parse."),this.key=this.key.match("d\\/(.*?)/")[1]),this.key?(this.log("Initializing with key "+this.key),this.models={},this.modelNames=[],this.model_names=this.modelNames,this.baseJsonPath="/feeds/worksheets/"+this.key+"/public/basic?alt=",this.baseJsonPath+=l||r?"json":"json-in-script",this.wait||this.fetch()):this.log("You need to pass Tabletop a key!")};o.callbacks={},o.init=function(e){return new o(e)},o.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")},o.prototype={fetch:function(e){void 0!==e&&(this.callback=e),this.requestData(this.baseJsonPath,this.loadSheets)},requestData:function(e,t){if(this.log("Requesting",e),l)this.serverSideFetch(e,t);else{var s=this.endpoint.split("//").shift()||"http";!r||n&&s!==location.protocol?this.injectScript(e,t):this.xhrFetch(e,t)}},xhrFetch:function(e,t){var s=n?new XDomainRequest:new XMLHttpRequest;s.open("GET",this.endpoint+e);var i=this;s.onload=function(){var e;try{e=JSON.parse(s.responseText)}catch(e){console.error(e)}t.call(i,e)},s.send()},injectScript:function(e,t){var s,i=document.createElement("script");if(this.singleton)t===this.loadSheets?s="Tabletop.singleton.loadSheets":t===this.loadSheet&&(s="Tabletop.singleton.loadSheet");else{var n=this;s="tt"+ +new Date+Math.floor(1e5*Math.random()),o.callbacks[s]=function(){var e=Array.prototype.slice.call(arguments,0);t.apply(n,e),i.parentNode.removeChild(i),delete o.callbacks[s]},s="Tabletop.callbacks."+s}var a=e+"&callback="+s;this.simpleUrl?-1!==e.indexOf("/list/")?i.src=this.endpoint+"/"+this.key+"-"+e.split("/")[4]:i.src=this.endpoint+"/"+this.key:i.src=this.endpoint+a,this.parameterize&&(i.src=this.parameterize+encodeURIComponent(i.src)),this.log("Injecting",i.src),document.getElementsByTagName("script")[0].parentNode.appendChild(i)},serverSideFetch:function(e,i){var n=this;this.log("Fetching",this.endpoint+e),t({url:this.endpoint+e,json:!0},function(e,t,s){if(e)return console.error(e);i.call(n,s)})},isWanted:function(e){return 0===this.wanted.length||-1!==s(this.wanted,e)},data:function(){if(0!==this.modelNames.length)return this.simpleSheet?(1<this.modelNames.length&&this.debug&&this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong."),this.models[this.modelNames[0]].all()):this.models},addWanted:function(e){-1===s(this.wanted,e)&&this.wanted.push(e)},loadSheets:function(e){var t,s,i=[];for(this.googleSheetName=e.feed.title.$t,this.foundSheetNames=[],t=0,s=e.feed.entry.length;t<s;t++)if(this.foundSheetNames.push(e.feed.entry[t].title.$t),this.isWanted(e.feed.entry[t].content.$t)){var n=e.feed.entry[t].link.length-1,a=e.feed.entry[t].link[n].href.split("/").pop(),o="/feeds/list/"+this.key+"/"+a+"/public/values?alt=";o+=l||r?"json":"json-in-script",this.query&&(o+="&tq="+this.query),this.orderby&&(o+="&orderby=column:"+this.orderby.toLowerCase()),this.reverse&&(o+="&reverse=true"),i.push(o)}for(this.sheetsToLoad=i.length,t=0,s=i.length;t<s;t++)this.requestData(i[t],this.loadSheet)},sheets:function(e){return void 0===e?this.models:void 0===this.models[e]?void 0:this.models[e]},sheetReady:function(e){this.models[e.name]=e,-1===s(this.modelNames,e.name)&&this.modelNames.push(e.name),this.sheetsToLoad--,0===this.sheetsToLoad&&this.doCallback()},loadSheet:function(e){var t=this;new o.Model({data:e,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this,prettyColumnNames:this.prettyColumnNames,onReady:function(){t.sheetReady(this)}})},doCallback:function(){0===this.sheetsToLoad&&this.callback.apply(this.callbackContext||this,[this.data(),this])},log:function(){this.debug&&"undefined"!=typeof console&&void 0!==console.log&&Function.prototype.apply.apply(console.log,[console,arguments])}},o.Model=function(e){var t,s,i,n;if(this.columnNames=[],this.column_names=this.columnNames,this.name=e.data.feed.title.$t,this.tabletop=e.tabletop,this.elements=[],this.onReady=e.onReady,this.raw=e.data,void 0===e.data.feed.entry)return e.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers"),this.originalColumns=[],this.elements=[],void this.onReady.call(this);for(var a in e.data.feed.entry[0])/^gsx/.test(a)&&this.columnNames.push(a.replace("gsx$",""));for(this.originalColumns=this.columnNames,this.original_columns=this.originalColumns,t=0,i=e.data.feed.entry.length;t<i;t++){var o=e.data.feed.entry[t],l={};for(s=0,n=this.columnNames.length;s<n;s++){var r=o["gsx$"+this.columnNames[s]];void 0!==r?e.parseNumbers&&""!==r.$t&&!isNaN(r.$t)?l[this.columnNames[s]]=+r.$t:l[this.columnNames[s]]=r.$t:l[this.columnNames[s]]=""}void 0===l.rowNumber&&(l.rowNumber=t+1),e.postProcess&&e.postProcess(l),this.elements.push(l)}e.prettyColumnNames?this.fetchPrettyColumns():this.onReady.call(this)},o.Model.prototype={all:function(){return this.elements},fetchPrettyColumns:function(){if(!this.raw.feed.link[3])return this.ready();var e=this.raw.feed.link[3].href.replace("/feeds/list/","/feeds/cells/").replace("https://spreadsheets.google.com",""),t=this;this.tabletop.requestData(e,function(e){t.loadPrettyColumns(e)})},ready:function(){this.onReady.call(this)},loadPrettyColumns:function(e){for(var t={},s=this.columnNames,i=0,n=s.length;i<n;i++)void 0!==e.feed.entry[i].content.$t?t[s[i]]=e.feed.entry[i].content.$t:t[s[i]]=s[i];this.prettyColumns=t,this.pretty_columns=this.prettyColumns,this.prettifyElements(),this.ready()},prettifyElements:function(){var e,t,s,i,n=[],a=[];for(t=0,i=this.columnNames.length;t<i;t++)a.push(this.prettyColumns[this.columnNames[t]]);for(e=0,s=this.elements.length;e<s;e++){var o={};for(t=0,i=this.columnNames.length;t<i;t++){o[this.prettyColumns[this.columnNames[t]]]=this.elements[e][this.columnNames[t]]}n.push(o)}this.elements=n,this.columnNames=a},toArray:function(){var e,t,s,i,n=[];for(e=0,s=this.elements.length;e<s;e++){var a=[];for(t=0,i=this.columnNames.length;t<i;t++)a.push(this.elements[e][this.columnNames[t]]);n.push(a)}return n}},"undefined"!=typeof module&&module.exports?module.exports=o:"function"==typeof define&&define.amd?define(function(){return o}):window.Tabletop=o}();